<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="stylesheet" type="text/css" href="./css/bootstrap.min.css">
    <title>index</title>
    <link rel="stylesheet" href="index.css">
</head>
<body>
   <div class="all">
       <div class="head">
           <div class="location">
               <span class="location-span">
                   <img src="./img/index-location.png" alt="">
                   浦东新区张江高科技园区内
                   <a href=""><img src="./img/index-icondown.png" alt=""></a>
               </span>
           </div>
           <div class="search">
               <a href="">
                   <img src="./img/index-search.png" alt="">
                   请输入商家或商品名称
               </a>
           </div>
       </div>
       <div class="main">
           <div class="carousel">
               <div id="carousel-example-generic" class="carousel slide" data-ride="carousel">
                   <ol class="carousel-indicators">
                       <li data-target="#carousel-example-generic" data-slide-to="0" class="active"></li>
                       <li data-target="#carousel-example-generic" data-slide-to="1"></li>
                       <li data-target="#carousel-example-generic" data-slide-to="2"></li>
                   </ol>
                   <div class="carousel-inner" role="listbox">
                       <div class="item active">
                           <img src="./img/index-carousel.png" alt="">
                           <div class="carousel-caption">
                               <!--John Rise-->
                           </div>
                       </div>
                       <div class="item">
                           <img src="./img/index-carousel.png" alt="">
                           <div class="carousel-caption">
                               <!--Eva Ital-->
                           </div>
                       </div>
                       <div class="item">
                           <img src="./img/index-carousel.png" alt="">
                           <div class="carousel-caption">
                               <!--Mono Kai-->
                           </div>
                       </div>

                   </div>
               </div>
               <div></div>
           </div>
           <div class="hot">
               <a href=""><img src="./img/index-hoticon1.png" alt=""><p>品牌馆</p></a>
               <a href=""><img src="./img/index-hoticon2.png" alt=""><p>预定早餐</p></a>
               <a href=""><img src="./img/index-hoticon3.png" alt=""><p>新店特惠</p></a>
               <a href=""><img src="./img/index-hoticon4.png" alt=""><p>限时抢购</p></a>
               <a href=""><img src="./img/index-hoticon5.png" alt=""><p>夜宵</p></a>
               <a href=""><img src="./img/index-hoticon6.png" alt=""><p>水果</p></a>
               <a href=""><img src="./img/index-hoticon7.png" alt=""><p>鲜花蛋糕</p></a>
               <a href=""><img src="./img/index-hoticon8.png" alt=""><p>推荐有奖</p></a>
           </div>
           <div class="list">
               <div class="nav">
                   <div>
                       <a>
                           <p>分类</p>
                           <img src="./img/index-listicondown.png" alt="">
                       </a>
                   </div>
                   <div class="sort">
                       <a>
                           <p>排序</p>
                           <img src="./img/index-listicondown.png" alt="">
                       </a>
                   </div>
                   <div>
                       <a>
                           <p>筛选</p>
                           <img src="./img/index-listicondown.png" alt="">
                       </a>
                   </div>
               </div>
               <ul class="merchantlist">
                   <li class="details">
                           <img src="./img/index-listicon1.png" alt="" class="headimg">
                           <div>
                               <ul>
                                   <li>
                                       <div>
                                           <p class="left name">必胜客欧尚餐厅</p>
                                           <span class="right">
                                           <p class="money big">¥30</p>
                                           <p>起送</p>
                                      </span>
                                       </div>
                                       <div>
                                         <span class="left">
                                           <img src="./img/index-liststart.png" alt="" class="start">
                                           <p>(53)</p>
                                           <p>月售167单</p>
                                         </span>
                                           <span class="right">
                                           <p class="money tip">¥7</p>
                                           <p class="tipfree">配送费</p>
                                        </span>
                                       </div>
                                       <div>
                                           <p class="left distance">2.54千米</p>
                                           <span class="right">
                                            <img src="./img/index-listlogo.png" alt="" class="logo">
                                        </span>
                                       </div>
                                   </li>
                                   <li>
                                    <span class="left">
                                        <a class="a discount">减</a>
                                        <p>满120元减30元</p>
                                    </span>
                                       <span class="left">
                                       <a class="a deductible">抵</a>
                                       <p>在该商家用抵用券订餐可抵10元</p>
                                   </span>
                                   </li>
                               </ul>
                           </div>
                   </li>
               </ul>
               <ul class="classification">
                    <li class="">
                        <p class="name">美食</p>
                        <div></div>
                    </li>
               </ul>
               <ul class="second">
                   <li>
                       <p class="name">全部</p>
                   </li>
               </ul>
           </div>
       </div>
       <div class="foot">
           <a href=""><img src="./img/active-pageicon1.png" alt=""><p>外卖</p></a>
           <a href="order.html"><img src="./img/pageicon2.png" alt=""><p>订单</p></a>
           <a href="find.html"><img src="./img/pageicon3.png" alt=""><p>发现</p></a>
           <a href="mine.html"><img src="./img/pageicon4.png" alt=""><p>我的</p></a>
       </div>
   </div>
   <script type="text/javascript" src="./jquery-3.2.1.min.js"></script>
   <script type="text/javascript" src="./js/bootstrap.min.js"></script>
   <script>
       $(document).ready(function(){
           var head = $(".head");
           var main = $(".main");
           var foot = $(".foot");
           var merchantlist = $(".merchantlist");
           var details = $(".details");
           var lastdetail = details.eq(details.length-1);
           var detailsname = $(".details .name");
           var distance = $(".distance");
           var big = $(".big");
           var tip =$(".tip");
           var tipfree = $(".tipfree");
           var start = $(".start");
           var startarr = ["./img/star0.png","./img/star1.png","./img/star2.png","./img/star3.png","./img/star4.png","./img/star5.png"];
           var headHeight = parseInt(head.css("height").substring(0,2));
           //接口
           var html = $.ajax({
               url:"http://localhost:5500/restaurant",
               dataType:"json",
               async:false,
               success:function(data){
                   window.data = data; //存入全局变量
               }
           });
           var i,j=0;
           if(data.length > 0){
               for(i= 1; i< 10 && i < data.length; i++ ) {
                   lastdetail.clone(true).appendTo(merchantlist);
                   details = $(".details");
                   lastdetail = details.eq(details.length-1);
               }
               for(j = 0;j<details.length;j++) {
                   detailsname = $(".details .name");
                   distance = $(".distance");
                   big = $(".big");
                   tip =$(".tip");
                   tipfree = $(".tipfree");
                   start = $(".start");
                   detailsname.eq(j).html(data[j].name);
                   distance.eq(j).html(data[j].distance.toFixed(1)+"千米");
                   big.eq(j).html("¥"+data[j].start);
                   if(data[j].tip === 0 ) {
                       tip.eq(j).html("");
                       tipfree.eq(j).html("免配送费")
                   }else{
                       tip.eq(j).html("¥"+data[j].tip);
                   }
                   start.eq(j).attr("src",startarr[data[j].star]);
               }
               window.alli = i;
               window.allj = j;
           }
           //滚动事件
           $(document).on("scroll",function(){
//               TopBar置顶效果
               if( $(document).scrollTop() >= headHeight/2 ) {
                   head.css("position","fixed");
                   head.css("top","-30px");
                   head.css("z-index","99");
                   main.css("margin-top",headHeight+"px");
               }
               if( $(document).scrollTop() <= headHeight/2) {
                   head.css("position","relative");
                   head.css("top","0");
                   main.css("margin-top","0")
               }
//                商家列表瀑布流加载
               if($(window).height()+$(document).scrollTop()-foot.height() >= lastdetail.offset().top) {
                   if (details.length < data.length) {
                       for (var i = alli ; i < alli + 10 && i < data.length; i++) {
                           lastdetail.clone(true).appendTo(merchantlist);
                           details = $(".details");
                           lastdetail = details.eq(details.length - 1);
                       }
                       for (var j = allj; j < details.length; j++) {
                           detailsname = $(".details .name");
                           distance = $(".distance");
                           big = $(".big");
                           tip =$(".tip");
                           tipfree = $(".tipfree");
                           start = $(".start");
                           detailsname.eq(j).html(data[j].name);
                           distance.eq(j).html(data[j].distance.toFixed(1)+"千米");
                           big.eq(j).html("¥"+data[j].start);
                           if(data[j].tip === 0 ) {
                               tip.eq(j).html("");
                               tipfree.eq(j).html("免配送费")
                           }else{
                               tip.eq(j).html("¥"+data[j].tip);
                           }
                           start.eq(j).attr("src",startarr[data[j].star]);
                       }
                   }
               }
           });
           details.on("click",function(){
               $(window).attr("location","merchantlist.html")
           });
           //分类菜单
           var nav = $(".nav div:first-child");
           var sort =$(".nav .sort");
           var carousel = $(".carousel");
           var hot = $(".hot");
           var list = $(".list");
           var second = $(".second");
           var classification = $(".classification");
           var classificationli = $(".classification li");
           var navok = 0;
           var navdata = 0;
           nav.on("click",function(){
                if( navok === 0 ) {
                    main.css("height","100%");
                    list.css("margin-top","0");
                    list.css("top","67px");
                    list.css("transition","top 0.3s");
                    main.css("background-color","rgba(0,0,0,0.7)");
                    carousel.hide();
                    hot.hide();
                    merchantlist.hide();
                    second.show();
                    classification.show();
                    if( navdata === 0 ) {
                        //接口
                        var html = $.ajax({
                            url:"http://localhost:5500/category",
                            dataType:"json",
                            async:false,
                            success:function(data){
                                window.classdata = data; //存入全局变量
                            }
                        });
                        //创建两个数组，一个放一级菜单，一个放二级菜单
                        var arrmain = [];
                        var arrsecondmain = [];
                        if( classdata.length > 0 ) {
                            for( var i= 0; i< classdata.length; i++ ) {
                                if( classdata[i].level === "0") {
                                    arrmain.push(classdata[i]);
                                }else{
                                    arrsecondmain.push(classdata[i]);
                                }
                            }
                            for(var j= 1; j< arrmain.length; j++) {
                                var mainclass = $(".classification li");
                                var lastmain = mainclass.eq(mainclass.length-1);
                                lastmain.clone(true).appendTo(lastmain.parent());
                                mainclass = $(".classification li");
                                lastmain = mainclass.eq(mainclass.length-1);
                            }
                            for(var k= 1; k<arrsecondmain.length; k++ ){
                                var secondclass = $(".second li");
                                var lastsecond = secondclass.eq(secondclass.length-1);
                                lastsecond.clone(true).appendTo(lastsecond.parent());
                                secondclass = $(".second li");
                                lastsecond = secondclass.eq(secondclass.length-1);
                            }
                            for(var m= 0; m< mainclass.length; m++) {
                                var mainclassname = $(".classification li .name");
                                mainclassname.eq(m).html(arrmain[m].name);
                            }
                            for(var n= 0; n< secondclass.length; n++) {
                                var secondclassname = $(".second li .name");
                                secondclassname.eq(n).html(arrsecondmain[n].name);
                            }
                        }
                        mainclass.eq(0).addClass("active");
                        var sortok = 0;
                        sort.on("click",function(){
                            if( sortok ===0 ) {
                                arrsecondmain.sort(function(a, b) {
                                    return b.order - a.order;
                                });
                                sortok = 1;
                                for(var n= 0; n< secondclass.length; n++) {
                                    var secondclassname = $(".second li .name");
                                    secondclassname.eq(n).html(arrsecondmain[n].name);
                                }
                            }
                            else if( sortok === 1 ) {
                                arrsecondmain.sort(function(a, b) {
                                    return a.order - b.order;
                                });
                                sortok = 0;
                                for(var n= 0; n< secondclass.length; n++) {
                                    var secondclassname = $(".second li .name");
                                    secondclassname.eq(n).html(arrsecondmain[n].name);
                                }
                            }
                            console.log(arrsecondmain);
                        });
                    }
                    navok = 1;
                    navdata = 1;
                }else if ( navok ===1 ) {
                    main.css("height","70%");
                    list.css("margin-top","10px");
                    list.css("top","320px");
                    list.css("transition","top 0.3s");
                    main.css("background-color","white");
                    carousel.show();
                    hot.show();
                    merchantlist.show();
                    second.hide();
                    classification.hide();
                    navok = 0;
           }
           });
           classificationli.on("click",function(){
               $(this).addClass("active");
               $(this).siblings().removeClass("active");
           });
       });
   </script>
</body>
</html>